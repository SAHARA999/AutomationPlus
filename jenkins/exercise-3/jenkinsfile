pipeline {
    agent any

    stages {
        stage('Prepare Env') {
            steps('install Lint') {
                  sh '''
                            python3 -m venv /tmp/jenkins
                            source /tmp/jenkins/bin/activate
                            pip install --upgrade pip
                            pip install ansible ansible-lint
                            ansible --version
                            ansible-lint --version
                   '''
            }
        }
        stage('Test') {
            steps {
                           sh '''
                           source /tmp/jenkins/bin/activate
                           ansible-lint -p playbook.yaml
                           '''
            }
        }
        stage('Deploy') {
             when {
              expression {
                currentBuild.result == null || currentBuild.result == 'SUCCESS' 
              }
            }
            steps {
                        sh '''
                      
                           ansible-playbook -c local -i "localhost, " playbook.yaml
                           '''
 
                 
            office365ConnectorSend webhookUrl: "https://accenture.webhook.office.com/webhookb2/17bc0c87-1be5-4dda-8577-7885719bb0d8@e0793d39-0939-496d-b129-198edd916feb/IncomingWebhook/ef70a1847d1c4776a3355cf3f579b724/224f8c65-6df3-4135-96a9-98c74b452e48",
            message: 'Application has been [deployed](https://uat.green.biz)',
            status: 'Success'            
            echo "Deploying ${env.BUILD_ID} on ${env.JENKINS_URL}"
            }
        }
    }
}
